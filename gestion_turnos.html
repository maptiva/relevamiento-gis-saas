<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambio de Turnos Imprevistos - Farmacias Chajarí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg p-8 space-y-6 bg-white rounded-lg shadow-md">

        <!-- Estado No Autenticado -->
        <div id="login-container">
            <h2 class="text-2xl font-bold text-center text-gray-800">Acceso al Panel de Gestión</h2>
            <p class="text-center text-gray-600">Inicia sesión para continuar</p>
            <form id="login-form" class="mt-6 space-y-4">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Contraseña</label>
                    <div class="relative mt-2">
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-2 pr-10 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" id="togglePassword">
                            <i class="fas fa-eye" id="eye-icon"></i>
                        </span>
                    </div>
                </div>
                <button type="submit"
                        class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Iniciar Sesión
                </button>
            </form>
            <div id="login-error" class="mt-4 text-sm text-center text-red-600"></div>
            <div class="mt-4 text-sm text-center">
                <a href="#" id="forgot-password-link" class="font-medium text-blue-600 hover:text-blue-500">¿Olvidaste tu contraseña?</a>
            </div>
        </div>

        <!-- Formulario de Reseteo de Contraseña (Oculto por defecto) -->
        <div id="reset-container" class="hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800">Restablecer Contraseña</h2>
            <p class="text-center text-gray-600">Ingresa tu email para recibir un enlace de restablecimiento.</p>
            <form id="reset-form" class="mt-6 space-y-4">
                <div>
                    <label for="reset-email" class="text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="reset-email" name="reset-email" required
                           class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit"
                        class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Enviar Enlace
                </button>
            </form>
            <div id="reset-status" class="mt-4 text-sm text-center"></div>
            <div class="mt-4 text-sm text-center">
                <a href="#" id="back-to-login-link" class="font-medium text-blue-600 hover:text-blue-500">Volver a Iniciar Sesión</a>
            </div>
        </div>

        <!-- Estado Autenticado -->
        <div id="gestion-container" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Panel de Gestión de Turnos</h2>
                <button id="logout-button" class="px-3 py-1 text-sm font-bold text-white bg-orange-500 rounded-md hover:bg-orange-600">
                    <i class="fas fa-sign-out-alt mr-1"></i>Cerrar Sesión
                </button>
            </div>
            
            <!-- Sección: Intercambio de Turnos Principales -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Intercambiar Turnos Principales</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Selecciona dos farmacias y las fechas de sus turnos principales para intercambiarlos.
                </p>
                <form id="exchange-principal-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="principalPharmacyA" class="block text-sm font-medium text-gray-700">Farmacia A</label>
                            <select id="principalPharmacyA" name="principalPharmacyA" required
                                    class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Cargando farmacias...</option>
                            </select>
                        </div>
                        <div>
                            <label for="principalDateA" class="block text-sm font-medium text-gray-700">Fecha A</label>
                            <select id="principalDateA" name="principalDateA" required disabled
                                   class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50">
                                <option value="">Primero selecciona una farmacia</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="principalPharmacyB" class="block text-sm font-medium text-gray-700">Farmacia B</label>
                            <select id="principalPharmacyB" name="principalPharmacyB" required
                                    class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Cargando farmacias...</option>
                            </select>
                        </div>
                        <div>
                            <label for="principalDateB" class="block text-sm font-medium text-gray-700">Fecha B</label>
                            <select id="principalDateB" name="principalDateB" required disabled
                                   class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50">
                                <option value="">Primero selecciona una farmacia</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit"
                            class="w-full px-4 py-2 font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <i class="fas fa-exchange-alt mr-2"></i>Realizar Intercambio Principal
                    </button>
                    <div id="principal-status" class="mt-4 text-sm text-center"></div>
                </form>
            </div>

            <!-- Sección: Intercambio de Turnos de Refuerzo -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Intercambiar Turnos de Refuerzo</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Selecciona dos farmacias y las fechas de sus turnos de refuerzo para intercambiarlos.
                </p>
                <form id="exchange-refuerzo-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="refuerzoPharmacyA" class="block text-sm font-medium text-gray-700">Farmacia A</label>
                            <select id="refuerzoPharmacyA" name="refuerzoPharmacyA" required
                                    class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Cargando farmacias...</option>
                            </select>
                        </div>
                        <div>
                            <label for="refuerzoDateA" class="block text-sm font-medium text-gray-700">Fecha A</label>
                            <select id="refuerzoDateA" name="refuerzoDateA" required disabled
                                   class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50">
                                <option value="">Primero selecciona una farmacia</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="refuerzoPharmacyB" class="block text-sm font-medium text-gray-700">Farmacia B</label>
                            <select id="refuerzoPharmacyB" name="refuerzoPharmacyB" required
                                    class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Cargando farmacias...</option>
                            </select>
                        </div>
                        <div>
                            <label for="refuerzoDateB" class="block text-sm font-medium text-gray-700">Fecha B</label>
                            <select id="refuerzoDateB" name="refuerzoDateB" required disabled
                                   class="w-full px-4 py-2 mt-1 text-gray-700 bg-gray-200 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50">
                                <option value="">Primero selecciona una farmacia</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit"
                            class="w-full px-4 py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-exchange-alt mr-2"></i>Realizar Intercambio Refuerzo
                    </button>
                    <div id="refuerzo-status" class="mt-4 text-sm text-center"></div>
                </form>
            </div>
        </div>
    </div>

<script type="module">
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC62b1ItiE0IzYKc8Y3tDIT5EXaOabUHOc",
        authDomain: "farmacias-chajari.firebaseapp.com",
        databaseURL: "https://farmacias-chajari-default-rtdb.firebaseio.com",
        projectId: "farmacias-chajari",
        storageBucket: "farmacias-chajari.appspot.com",
        messagingSenderId: "480200517460",
        appId: "1:480200517460:web:4cc22cd97a7b292e200ac1"
    };

    // Importar funciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        onAuthStateChanged, 
        signOut,
        sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        doc,
        getDoc,
        writeBatch 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Elementos del DOM ---
    const loginContainer = document.getElementById('login-container');
    const gestionContainer = document.getElementById('gestion-container');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutButton = document.getElementById('logout-button');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eye-icon');

    // Contenedores de Autenticación
    const resetContainer = document.getElementById('reset-container');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const backToLoginLink = document.getElementById('back-to-login-link');
    const resetForm = document.getElementById('reset-form');
    const resetStatus = document.getElementById('reset-status');

    // Formularios de Intercambio
    const exchangePrincipalForm = document.getElementById('exchange-principal-form');
    const exchangeRefuerzoForm = document.getElementById('exchange-refuerzo-form');
    
    // Selects de Farmacias
    const principalPharmacyA = document.getElementById('principalPharmacyA');
    const principalPharmacyB = document.getElementById('principalPharmacyB');
    const refuerzoPharmacyA = document.getElementById('refuerzoPharmacyA');
    const refuerzoPharmacyB = document.getElementById('refuerzoPharmacyB');

    // Selects de Fechas
    const principalDateA = document.getElementById('principalDateA');
    const principalDateB = document.getElementById('principalDateB');
    const refuerzoDateA = document.getElementById('refuerzoDateA');
    const refuerzoDateB = document.getElementById('refuerzoDateB');

    // Elementos de Estado
    const principalStatus = document.getElementById('principal-status');
    const refuerzoStatus = document.getElementById('refuerzo-status');

    // --- LÓGICA DE AUTENTICACIÓN ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginContainer.classList.add('hidden');
            gestionContainer.classList.remove('hidden');
            populateAllPharmacySelects();
        } else {
            loginContainer.classList.remove('hidden');
            gestionContainer.classList.add('hidden');
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        try {
            await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value);
        } catch (error) {
            loginError.textContent = 'Email o contraseña incorrectos.';
        }
    });

    logoutButton.addEventListener('click', () => signOut(auth));

    togglePassword.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        eyeIcon.classList.toggle('fa-eye');
        eyeIcon.classList.toggle('fa-eye-slash');
    });

    // --- LÓGICA DE RESETEO DE CONTRASEÑA ---
    forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginContainer.classList.add('hidden');
        resetContainer.classList.remove('hidden');
    });

    backToLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        resetContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
        resetStatus.textContent = ''; // Limpiar mensajes de estado
        loginError.textContent = '';
    });

    resetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = resetForm['reset-email'].value;
        resetStatus.textContent = 'Enviando...';
        resetStatus.className = 'mt-4 text-sm text-center text-yellow-600';

        try {
            await sendPasswordResetEmail(auth, email);
            resetStatus.textContent = '¡Correo enviado! Revisa tu bandeja de entrada para restablecer la contraseña.';
            resetStatus.className = 'mt-4 text-sm text-center text-green-600';
        } catch (error) {
            console.error("Error al enviar correo de reseteo:", error);
            resetStatus.textContent = 'No se pudo enviar el correo. Verifica que la dirección sea correcta.';
            resetStatus.className = 'mt-4 text-sm text-center text-red-600';
        }
    });

    // --- LÓGICA DE GESTIÓN DE TURNOS ---

    // Función auxiliar para formatear la fecha para el usuario
    function formatDateForDisplay(dateString) { // AAAA-MM-DD -> DD-MM-AAAA
        const [year, month, day] = dateString.split('-');
        return `${day}-${month}-${year}`;
    }

    // 1. Poblar los <select> de farmacias
    async function populateAllPharmacySelects() {
        try {
            const farmaciasRef = collection(db, "farmacias");
            const querySnapshot = await getDocs(farmaciasRef);
            
            const farmacias = [];
            querySnapshot.forEach((doc) => {
                farmacias.push({ id: doc.id, ...doc.data() });
            });

            // Ordenar farmacias alfabéticamente por nombre
            farmacias.sort((a, b) => a.nombre.localeCompare(b.nombre));

            const selects = [principalPharmacyA, principalPharmacyB, refuerzoPharmacyA, refuerzoPharmacyB];
            selects.forEach(sel => {
                sel.innerHTML = '<option value="">Selecciona una farmacia...</option>'; // Placeholder
                farmacias.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = f.nombre;
                    sel.appendChild(option);
                });
            });
        } catch (error) {
            console.error("Error al cargar farmacias:", error);
            principalStatus.textContent = "Error al cargar la lista de farmacias.";
        }
    }

    // 2. Poblar los <select> de fechas cuando se elige una farmacia
    async function populateDateSelect(pharmacyId, dateSelect, turnoType) {
        // Resetear y deshabilitar el select de fecha
        dateSelect.innerHTML = '<option value="">Cargando fechas...</option>';
        dateSelect.disabled = true;

        if (!pharmacyId) {
            dateSelect.innerHTML = '<option value="">Primero selecciona una farmacia</option>';
            return;
        }

        try {
            const farmaciaRef = doc(db, "farmacias", pharmacyId);
            const docSnap = await getDoc(farmaciaRef);

            if (docSnap.exists()) {
                const turnos = docSnap.data().turnos || [];
                const turnosFiltrados = turnos
                    .filter(t => t.tipo === turnoType)
                    .sort((a, b) => a.fecha.localeCompare(b.fecha)); // Ordenar fechas

                dateSelect.innerHTML = ''; // Limpiar opciones
                if (turnosFiltrados.length === 0) {
                    dateSelect.innerHTML = `<option value="">No hay turnos de ${turnoType}</option>`;
                    return;
                }
                
                turnosFiltrados.forEach(turno => {
                    const option = document.createElement('option');
                    option.value = turno.fecha; // El valor sigue siendo AAAA-MM-DD
                    option.textContent = formatDateForDisplay(turno.fecha); // El texto es DD-MM-AAAA
                    dateSelect.appendChild(option);
                });
                dateSelect.disabled = false; // Habilitar select
            } else {
                dateSelect.innerHTML = '<option value="">Farmacia no encontrada</option>';
            }
        } catch (error) {
            console.error(`Error al cargar fechas para ${pharmacyId}:`, error);
            dateSelect.innerHTML = '<option value="">Error al cargar fechas</option>';
        }
    }

    // 3. Lógica para manejar el intercambio (Enroque)
    async function handleExchange(e, type) {
        e.preventDefault();
        const statusElement = type === 'principal' ? principalStatus : refuerzoStatus;
        statusElement.textContent = 'Procesando intercambio...';
        statusElement.className = 'mt-4 text-sm text-center text-yellow-600';

        const form = e.target;
        const pharmacyAId = form[`${type}PharmacyA`].value;
        const dateA = form[`${type}DateA`].value;
        const pharmacyBId = form[`${type}PharmacyB`].value;
        const dateB = form[`${type}DateB`].value;

        if (!pharmacyAId || !dateA || !pharmacyBId || !dateB) {
            statusElement.textContent = 'Error: Debes completar todos los campos.';
            statusElement.className = 'mt-4 text-sm text-center text-red-600';
            return;
        }
        if (pharmacyAId === pharmacyBId) {
            statusElement.textContent = 'Error: No se puede intercambiar turnos en la misma farmacia.';
            statusElement.className = 'mt-4 text-sm text-center text-red-600';
            return;
        }

        try {
            const batch = writeBatch(db);
            const refA = doc(db, "farmacias", pharmacyAId);
            const refB = doc(db, "farmacias", pharmacyBId);

            const [docA, docB] = await Promise.all([getDoc(refA), getDoc(refB)]);

            if (!docA.exists() || !docB.exists()) {
                throw new Error("Una o ambas farmacias no fueron encontradas.");
            }

            const dataA = docA.data();
            const dataB = docB.data();

            // Encontrar los turnos a intercambiar
            const turnoA = dataA.turnos.find(t => t.fecha === dateA && t.tipo === type);
            const turnoB = dataB.turnos.find(t => t.fecha === dateB && t.tipo === type);

            if (!turnoA || !turnoB) {
                throw new Error(`No se encontró el turno de tipo '${type}' en la fecha especificada para una o ambas farmacias.`);
            }

            // Crear los nuevos arrays de turnos
            const nuevosTurnosA = dataA.turnos.filter(t => t.fecha !== dateA || t.tipo !== type);
            nuevosTurnosA.push(turnoB);
            nuevosTurnosA.sort((a, b) => a.fecha.localeCompare(b.fecha)); // ¡NUEVO! Ordenar el array

            const nuevosTurnosB = dataB.turnos.filter(t => t.fecha !== dateB || t.tipo !== type);
            nuevosTurnosB.push(turnoA);
            nuevosTurnosB.sort((a, b) => a.fecha.localeCompare(b.fecha)); // ¡NUEVO! Ordenar el array

            // Añadir las operaciones de actualización al batch
            batch.update(refA, { turnos: nuevosTurnosA });
            batch.update(refB, { turnos: nuevosTurnosB });

            // Ejecutar el batch
            await batch.commit();

            statusElement.textContent = `¡Éxito! Se intercambió el turno ${type} de ${dataA.nombre} (${dateA}) con el de ${dataB.nombre} (${dateB}).`;
            statusElement.className = 'mt-4 text-sm text-center text-green-600';
            
            // Resetear los selects de fecha para forzar nueva selección
            populateDateSelect(pharmacyAId, form[`${type}DateA`], type);
            populateDateSelect(pharmacyBId, form[`${type}DateB`], type);

        } catch (error) {
            console.error("Error al intercambiar turnos:", error);
            statusElement.textContent = `Error: ${error.message}`;
            statusElement.className = 'mt-4 text-sm text-center text-red-600';
        }
    }

    // 4. Event Listeners
    principalPharmacyA.addEventListener('change', (e) => populateDateSelect(e.target.value, principalDateA, 'principal'));
    principalPharmacyB.addEventListener('change', (e) => populateDateSelect(e.target.value, principalDateB, 'principal'));
    refuerzoPharmacyA.addEventListener('change', (e) => populateDateSelect(e.target.value, refuerzoDateA, 'refuerzo'));
    refuerzoPharmacyB.addEventListener('change', (e) => populateDateSelect(e.target.value, refuerzoDateB, 'refuerzo'));

    exchangePrincipalForm.addEventListener('submit', (e) => handleExchange(e, 'principal'));
    exchangeRefuerzoForm.addEventListener('submit', (e) => handleExchange(e, 'refuerzo'));

</script>

</body>
</html>